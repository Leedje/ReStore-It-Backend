stages:
  - install-commands
  - build
  - test
  - sonarcloud-check

variables:
  JAVA_HOME: "C:/Program Files/Java/jdk-21"
  PATH: "$JAVA_HOME/bin:/tmp/gradle/gradle-7.4.2/bin:$PATH"
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  GIT_DEPTH: "0"
  GIT_STRATEGY: none

check_gitVersion:
  stage: install-commands
  tags: [gradle]
  script:
    - $env:Path += ";C:\Program Files\Git\cmd"
    - git --version

gradle_install:
  stage: install-commands
  script:
    - Invoke-WebRequest https://services.gradle.org/distributions/gradle-7.4.2-bin.zip -OutFile gradle-7.4.2-bin.zip
    - Expand-Archive gradle-7.4.2-bin.zip -DestinationPath /tmp/gradle
    - $env:PATH += ";/tmp/gradle/gradle-7.4.2/bin"
    - gradle -v

sonar_install:
  stage: install-commands
  script:
    - Invoke-WebRequest https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.7.0.2747-windows.zip -OutFile sonar-scanner-cli.zip
    - Expand-Archive sonar-scanner-cli.zip -DestinationPath "C:\tmp\sonar-scanner"
    - $env:PATH += ";C:\tmp\sonar-scanner\sonar-scanner-4.7.0.2747-windows\bin"
    - sonar-scanner --version

build_project:
  stage: build
  tags: [gradle]
  before_script:
    - $env:PATH += ";/tmp/gradle/gradle-7.4.2/bin"
  script:
    - gradle clean build

run_tests:
  stage: test
  tags: [gradle]
  before_script:
    - $env:PATH += ";/tmp/gradle/gradle-7.4.2/bin"
  script:
    - gradle test

sonarcloud-check:
  stage: sonarcloud-check
  tags: [gradle]
  before_script:
    - $env:PATH += ";/tmp/gradle/gradle-7.4.2/bin"
  script:
    - gradle sonarqube